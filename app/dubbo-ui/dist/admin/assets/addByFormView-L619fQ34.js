import{u as ce}from"./index-Va7nxJVK.js";import{d as ue,x as de,y as re,W as pe,F as z,k as _e,a as fe,z as N,u as ye,r as ve,D as J,c as W,b as e,w as t,e as i,o as k,f as r,G as g,n as S,a9 as be,aa as he,J as me,K as ke,j as x,t as B,I as L,Q as P,p as ge,h as xe,_ as we}from"./index-hmLAZQYT.js";import{f as $e}from"./traffic-C2a-KjHH.js";import"./request-8jI_GZey.js";const E=A=>(ge("data-v-74fb5f17"),A=A(),xe(),A),Ce={class:"__container_tagRule_detail"},Ue={style:{"max-width":"400px",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"}},Ke=E(()=>x("br",null,null,-1)),Ne=E(()=>x("br",null,null,-1)),Oe=E(()=>x("br",null,null,-1)),Re=E(()=>x("br",null,null,-1)),Ee=E(()=>x("br",null,null,-1)),Te=E(()=>x("br",null,null,-1)),je={class:"bottom-action-footer"},Se=ue({__name:"addByFormView",setup(A){const w=de(re.PROVIDE_INJECT_KEY);pe(()=>{if(!z.isNil(w.tagRule)){const{enabled:a=!0,key:l,scope:u,runtime:p=!0,tags:n}=w.tagRule;c.enable=a,c.objectOfAction=l,c.ruleGranularity=u,c.runtime=p,n&&n.length&&n.forEach((b,d)=>{m.value.push({tagName:b.name,scope:{type:"labels",labels:[],addresses:{condition:"=",addressesStr:""}}});const{match:_}=b;let s=[];_.forEach((y,f)=>{s.push({myKey:y.key,condition:Object.keys(y.value)[0],value:y.value[Object.keys(y.value)[0]]})}),m.value[d]&&m.value[d].scope&&(m.value[d].scope.labels=s)})}}),_e(),fe();const O=N(!1),G=N(8);ce().toClipboard;const Y=ye(),q=(a,l)=>{var n,b,d,_;let u=`对于应用 ${l||"未指定"}，将满足 `;const p=[];if(((n=a.scope)==null?void 0:n.type)==="labels"&&((b=a.scope.labels)==null?void 0:b.length)>0)a.scope.labels.forEach(s=>{var C,v;let y="";if(s.myKey==="method")y="请求方法";else if((C=s.myKey)!=null&&C.startsWith("args[")){const T=(v=s.myKey.match(/\[(\d+)\]/))==null?void 0:v[1];T!==void 0?y=`第 ${parseInt(T)+1} 个参数`:y=`标签 ${s.myKey||"未指定"}`}else y=`标签 ${s.myKey||"未指定"}`;let f="";const h=s.value||"未指定";switch(s.condition){case"exact":f=`exact ${h}`;break;case"regex":f=`regex ${h}`;break;case"prefix":f=`prefix ${h}`;break;case"noempty":f="noempty";break;case"empty":f="empty";break;case"wildcard":f=`wildcard ${h}`;break;case"!=":f=`!= ${h}`;break;default:f=`${s.condition||"未知关系"} ${h}`}s.condition!=="empty"&&s.condition!=="noempty"&&!s.value?p.push(`${y} 未填写`):p.push(`${y} ${f}`)});else if(((d=a.scope)==null?void 0:d.type)==="addresses"&&((_=a.scope.addresses)!=null&&_.addressesStr)){const s=a.scope.addresses.condition==="="?"等于":"不等于";p.push(`地址 ${s} [${a.scope.addresses.addressesStr}]`)}return p.length===0?u+="任意请求":u+=p.join(" 且 "),u+=` 的实例，打上 ${a.tagName||"未指定"} 标签，划入 ${a.tagName||"未指定"} 的隔离环境`,u},c=ve({ruleGranularity:"application",objectOfAction:"",enable:!0,faultTolerantProtection:!0,runtime:!0,priority:1,configVersion:"v3.0"});J(c,a=>{const{enable:l,objectOfAction:u,runtime:p,ruleGranularity:n}=a;w.tagRule={...w.tagRule,enabled:l,key:u,runtime:p,scope:n}},{immediate:!!z.isNil(w.tagRule)});const M=N([{label:"labels",value:"labels"}]),Q=N([{label:"exact",value:"exact"},{label:"regex",value:"regex"},{label:"prefix",value:"prefix"},{label:"noempty",value:"noempty"},{label:"empty",value:"empty"},{label:"wildcard",value:"wildcard"}]),H=N([{label:"=",value:"="},{label:"!=",value:"!="}]),X=N([{title:"键",dataIndex:"myKey",key:"myKey"},{title:"关系",dataIndex:"condition",key:"condition"},{title:"值",dataIndex:"value",key:"value"},{title:"操作",dataIndex:"operation",key:"operation"}]),m=N([]);J(m,a=>{console.log(a);const l=[];a.forEach(u=>{const{tagName:p,scope:n}=u,b=n.labels,d={name:p,match:[]};b&&b.length>0&&b.forEach(_=>{d.match.push({key:_.myKey,value:{[_.condition]:_.value}})}),l.push(d)}),w.tagRule={...w.tagRule,tags:l}},{deep:!0,immediate:!!z.isNil(w.tagRule)});const Z=(a,l)=>{if(m.value[a].scope.labels.length===1){m.value[a].scope.type="addresses";return}m.value[a].scope.labels.splice(l,1)},I=a=>{m.value[a].scope.labels.push({myKey:"",condition:"exact",value:""})},ee=()=>{m.value.push({tagName:"",scope:{type:"labels",labels:[{myKey:"",condition:"",value:""}],addresses:{condition:"",addressesStr:""}}})},te=a=>{m.value.splice(a,1)},ae=async()=>{const{ruleGranularity:a,objectOfAction:l,enable:u,faultTolerantProtection:p,runtime:n,priority:b,configVersion:d}=c,_={configVersion:d,scope:a,key:l,enabled:u,runtime:n,tags:[]};m.value.forEach((f,h)=>{const C={name:f.tagName,match:[]};f.scope.labels.forEach((v,T)=>{const D={key:v.myKey,value:{}};D.value[v.condition]=v.value,C.match.push(D)}),_.tags.push(C)});let s="";a=="application"?s=`${l}.tag-router`:s=`${l}:${d}.tag-router`,(await $e(s,_)).code===200&&Y.push("/traffic/tagRule")};return(a,l)=>{const u=i("a-button"),p=i("a-flex"),n=i("a-form-item"),b=i("a-switch"),d=i("a-col"),_=i("a-input"),s=i("a-input-number"),y=i("a-row"),f=i("a-form"),h=i("a-card"),C=i("a-tooltip"),v=i("a-space"),T=i("a-radio-group"),D=i("a-tag"),F=i("a-select"),le=i("a-table"),oe=i("a-textarea"),V=i("a-descriptions-item"),ne=i("a-descriptions"),se=i("a-affix");return k(),W("div",Ce,[e(p,{style:{width:"100%"}},{default:t(()=>[e(d,{span:O.value?24-G.value:24,class:"left"},{default:t(()=>[e(h,null,{default:t(()=>[e(v,{style:{width:"100%"},direction:"vertical",size:"middle"},{default:t(()=>[e(y,null,{default:t(()=>[e(p,{justify:"end",style:{width:"100%"}},{default:t(()=>[e(u,{type:"text",style:{color:"#0a90d5"},onClick:l[0]||(l[0]=o=>O.value=!O.value)},{default:t(()=>[r(" 字段说明 "),O.value?(k(),g(S(he),{key:1})):(k(),g(S(be),{key:0}))]),_:1})]),_:1}),e(h,{title:"基础信息",style:{width:"100%"},class:"_detail"},{default:t(()=>[e(f,{layout:"horizontal"},{default:t(()=>[e(y,{style:{width:"100%"}},{default:t(()=>[e(d,{span:12},{default:t(()=>[e(n,{label:"规则粒度",required:""},{default:t(()=>[r(" 应用")]),_:1}),e(n,{label:"容错保护"},{default:t(()=>[e(b,{checked:c.faultTolerantProtection,"onUpdate:checked":l[1]||(l[1]=o=>c.faultTolerantProtection=o),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1}),e(n,{label:"运行时生效"},{default:t(()=>[e(b,{checked:c.runtime,"onUpdate:checked":l[2]||(l[2]=o=>c.runtime=o),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1})]),_:1}),e(d,{span:12},{default:t(()=>[e(n,{label:"作用对象",required:""},{default:t(()=>[e(_,{value:c.objectOfAction,"onUpdate:value":l[3]||(l[3]=o=>c.objectOfAction=o),style:{width:"200px"}},null,8,["value"])]),_:1}),e(n,{label:"立即启用"},{default:t(()=>[e(b,{checked:c.enable,"onUpdate:checked":l[4]||(l[4]=o=>c.enable=o),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1}),e(n,{label:"优先级"},{default:t(()=>[e(s,{min:"1",value:c.priority,"onUpdate:value":l[5]||(l[5]=o=>c.priority=o)},null,8,["value"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(h,{title:"标签列表",style:{width:"100%"},class:"_detail"},{default:t(()=>[(k(!0),W(me,null,ke(m.value,(o,j)=>(k(),g(h,{key:j},{title:t(()=>[e(v,{align:"center"},{default:t(()=>[x("div",null,"路由【"+B(j+1)+"】",1),e(C,null,{title:t(()=>[r(B(q(o,c.objectOfAction)),1)]),default:t(()=>[x("div",Ue,B(q(o,c.objectOfAction)),1)]),_:2},1024)]),_:2},1024)]),default:t(()=>[e(f,{layout:"horizontal"},{default:t(()=>[e(v,{style:{width:"100%"},direction:"vertical",size:"large"},{default:t(()=>[e(p,{justify:"end"},{default:t(()=>[e(S(L),{onClick:U=>te(j),class:"action-icon",icon:"tdesign:delete"},null,8,["onClick"])]),_:2},1024),e(n,{label:"标签名",required:""},{default:t(()=>[e(_,{placeholder:"隔离环境名",value:o.tagName,"onUpdate:value":U=>o.tagName=U},null,8,["value","onUpdate:value"])]),_:2},1024),e(n,{label:"作用范围",required:""},{default:t(()=>[e(h,null,{default:t(()=>[e(v,{style:{width:"100%"},direction:"vertical"},{default:t(()=>[e(n,{label:"匹配条件类型"},{default:t(()=>[e(T,{value:o.scope.type,"onUpdate:value":U=>o.scope.type=U,options:M.value},null,8,["value","onUpdate:value","options"])]),_:2},1024),e(v,{align:"start",style:{width:"100%"},direction:"horizontal"},{default:t(()=>{var U;return[e(D,{bordered:!1,color:"processing"},{default:t(()=>[r(B(o.scope.type),1)]),_:2},1024),o.scope.type==="labels"?(k(),g(le,{key:0,pagination:!1,columns:X.value,"data-source":(U=o.scope)==null?void 0:U.labels},{bodyCell:t(({column:$,record:R,text:Ae,index:ie})=>[$.key==="myKey"?(k(),g(_,{key:0,placeholder:"label key",value:R.myKey,"onUpdate:value":K=>R.myKey=K},null,8,["value","onUpdate:value"])):P("",!0),$.key==="condition"?(k(),g(F,{key:1,value:R.condition,"onUpdate:value":K=>R.condition=K,style:{width:"120px"},options:Q.value},null,8,["value","onUpdate:value","options"])):P("",!0),$.key==="value"?(k(),g(_,{key:2,placeholder:"label value",value:R.value,"onUpdate:value":K=>R.value=K},null,8,["value","onUpdate:value"])):$.key==="operation"?(k(),g(v,{key:3,align:"center"},{default:t(()=>[e(S(L),{icon:"tdesign:remove",class:"action-icon",onClick:K=>Z(j,ie)},null,8,["onClick"]),e(S(L),{class:"action-icon",icon:"tdesign:add",onClick:K=>I(j)},null,8,["onClick"])]),_:2},1024)):P("",!0)]),_:2},1032,["columns","data-source"])):(k(),g(v,{key:1,align:"start"},{default:t(()=>[e(F,{style:{width:"120px"},value:o.scope.addresses.condition,"onUpdate:value":$=>o.scope.addresses.condition=$,options:H.value},null,8,["value","onUpdate:value","options"]),e(oe,{style:{width:"500px"},value:o.scope.addresses.addressesStr,"onUpdate:value":$=>o.scope.addresses.addressesStr=$,placeholder:'地址列表，如有多个用"，"隔开'},null,8,["value","onUpdate:value"])]),_:2},1024))]}),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(u,{onClick:ee,type:"primary"},{default:t(()=>[r(" 增加标签")]),_:1})]),_:1})]),_:1})]),_:1},8,["span"]),e(d,{span:O.value?G.value:0,class:"right"},{default:t(()=>[O.value?(k(),g(h,{key:0,class:"sliderBox"},{default:t(()=>[x("div",null,[e(ne,{title:"字段说明",column:1},{default:t(()=>[e(V,{label:"key"},{default:t(()=>[r(" 作用对象"),Ke,r(" 可能的值：Dubbo应用名或者服务名 ")]),_:1}),e(V,{label:"scope"},{default:t(()=>[r(" 规则粒度"),Ne,r(" 可能的值：application, service ")]),_:1}),e(V,{label:"force"},{default:t(()=>[r(" 容错保护"),Oe,r(" 可能的值：true, false"),Re,r(" 描述：如果为true，则路由筛选后若没有可用的地址则会直接报异常；如果为false，则会从可用地址中选择完成RPC调用 ")]),_:1}),e(V,{label:"runtime"},{default:t(()=>[r(" 运行时生效"),Ee,r(" 可能的值：true, false"),Te,r(" 描述：如果为true，则该rule下的所有路由将会实时生效；若为false，则只有在启动时才会生效 ")]),_:1})]),_:1})])]),_:1})):P("",!0)]),_:1},8,["span"])]),_:1}),e(se,{"offset-bottom":10},{default:t(()=>[x("div",je,[e(v,{align:"center",size:"large"},{default:t(()=>[e(u,{type:"primary",onClick:ae},{default:t(()=>[r(" 确认")]),_:1}),e(u,null,{default:t(()=>[r(" 取消")]),_:1})]),_:1})])]),_:1})])}}}),ze=we(Se,[["__scopeId","data-v-74fb5f17"]]);export{ze as default};
